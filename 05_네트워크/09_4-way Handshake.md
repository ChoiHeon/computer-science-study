# 4_way Handshake

3-way Handshake는 TCP의 연결을 위해 사용했다면 4-wau Handshake는 세션을 종료하기 위해 수행되는 절차입니다.

> 세션(Session)이란 HTTP 프로토콜을 사용하는 인터넷 사용자가 어떤 웹 사이트를 방문할 경우, 사용자와 서버 사이의 연결을 확인하기 위한 정보입니다. 

<br>

## 해제 과정

1. Client > Server / FIN
   * 서버에게 연결을 종료하겠다는 FIN 패킷을 전송합니다.
2. Server > Client / ACK
   * FIN 패킷에 대한 응답으로 ACK 패킷을 전송합니다.
3. Server > Client  / FIN
   * 서버가 연결을 종료할 준비가 되면 FIN 패킷을 전송합니다.
4. Client > Server / ACK
   * 서버로부터 받은 FIN 패킷에 대한 응답으로 ACK 패킷을 전송합니다.
   * ACK 패킷을 전송한 후 바로 연결을 종료하지 않습니다. 
   * 서버에서 FIN 패킷을 보내기 전에 전송한 패킷이 지연되어 도착할 수 있기 때문에 일정 시간을 기다린 후에 세션을 만료하고 연결을 종료합니다.
   * ACK 패킷을 받은 서버는 소켓을 닫습니다.

<br>

## 에러 발생

위의 과정에서 다음과 같은 에러가 발생할 수 있습니다.

* 클라이언트에서 FIN 패킷을 전송한 후 ACK 패킷을 대기
* 서버의 ACK 패킷을 받은 후 FIN 패킷을 대기

위의 두 가지 상황에서 타임아웃이 발생하면 클라이언트는 스스로 연결을 종료합니다.

만약 ACK 패킷을 전송한 서버가 이후 제대로 연결을 종료할 준비를 못할 경우, CLOSE_WAIT 상태에 빠지므로 Socket Hang Up 에러가 발생할 수 있습니다.